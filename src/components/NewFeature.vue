<template lang="pug">
#NewFeature.mt5(v-show="show")
    p(v-if="mode==='locating'") Click to locate the new item on the map.
    button.f6.link.dim.ph3.pv2.mb2.dib.white.bg-purple(@click="clickAdd" v-if="mode === ''") 
        span(v-if="cloneFeature") Copy point
        span(v-else) New point
    .ba.pa2.b--mid-gray.bg-white(v-if="mode === 'confirming'")
        template(v-for="field in fields")
            label.f5.mb1.db {{ field.title }}

            input.input-reset.mb3(v-if="field.type === 'text'" v-model="feature.properties[field.property]")
            textarea.input-reset.mb3(v-if="field.type === 'textarea'" v-model="feature.properties[field.property]")
            //- label.f5.mb1.mt3.db Description
            //- textarea.input-reset(v-model="feature.properties.description")
        br
        button.mv2.mr2.f6.link.dim.ph3.pv2.mb2.dib.white.bg-purple(@click="clickSave") Save
        button.f6.link.dim.ph3.pv2.mb2.dib.white.bg-gray(@click="clickCancel") Cancel
    button.f6.link.dim.ph3.pv2.mb2.dib.white.bg-gray(@click="clickCancel" v-if="mode === 'locating'") Cancel
</template>

<script>
import { EventBus } from './EventBus';
import { saveFeature, updateFeature, layer, canEdit } from './sharedMapApi';

export default {
    name: "NewFeature",
    data: () => ({
        mode: '',
        feature: {},
        fields: [
            { title: 'Name', property: 'name', type: 'text' },
            // { title: 'Description', property: 'description', type: 'textarea' },
        ],
        cloneFeature: undefined
    }),
    created() {
        window.NewFeature = this;
        EventBus.$on('Map-clickLocate', lngLat => {
            const feature = {
                type: 'Feature',
                properties: {
                },
                geometry: {
                    type: 'Point',
                    coordinates: [lngLat.lng, lngLat.lat]
                },
            };
            for (const field of this.fields) {
                if (this.cloneFeature) {

                    feature.properties[field.property] = this.cloneFeature.properties[field.property];
                } else {

                    feature.properties[field.property] = ''
                }
            };
            this.feature = feature;
            if (this.cloneFeature) {
                this.clickSave();
            } else {
                this.mode = 'confirming'
            }
        });
        EventBus.$on('edit-feature', feature => {
            const f = JSON.parse(JSON.stringify(feature));
            this.feature = {
                type: f.type,
                properties: f.properties,
                geometry: f.geometry,
                id: f.id
            };
            this.mode = 'confirming';
        });
        EventBus.$on('start-clone', feature => {
            this.cloneFeature = JSON.parse(JSON.stringify(feature));
            this.mode = 'locating';
        });
    },
    computed: {
        show() {
            return canEdit();
        }
    },
    methods: {
        clickAdd() {
            // this.cloneFeature = undefined;;
            this.mode = 'locating';
        },
        clickCancel() {
            this.mode = '';
        },
        async clickSave() {
            this.mode = '';
            
            EventBus.$emit('NewFeature-save', this.feature);
            if (this.feature.id) {
                this.feature._id = this.feature.id;
                delete(this.feature.id);
                if (await updateFeature(this.feature)) {
                    EventBus.$emit('update-feature', this.feature);
                    console.log('updated', this.feature);
                } // else error?
            } else {
                const savedFeature = (await saveFeature(this.feature));
                EventBus.$emit('NewFeature-saved', savedFeature);
                console.log('saved', savedFeature);
            }
        },
    },
    watch: {
        mode() {
            EventBus.$emit('NewFeature-mode', this.mode);
        }
    }
}
</script>

<style scoped>
input,textarea {
    width: calc(100% - 1em);
}

</style>